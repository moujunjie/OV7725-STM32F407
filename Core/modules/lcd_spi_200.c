/***
	************************************************************************************************************************************************************************************************
	*	@version V1.0
	*  @date    2023-5-18
	*	@author  ??????
	*	@brief   SPI???????????????????? ST7789
   **********************************************************************************************************************************************************************************************
   *  @description
	*
	*	???????????STM32F407VET6????? ??????FK407M3-VET6??+ 2.00???????˜œ????SPI200M1-240*320??
	*	????????https://shop212360197.taobao.com
	*	QQ???????536665479
	*
>>>>> ????????
	*
	*  1.????????16¶ÀRGB565???
	*  2.SPI??????? 21M  
   *
>>>>> ?????????
	*
	*	1. ?????????????ß≥??????????????????????????????????????????????????
	*	2. ????????????????????¶œ??????????
	*
	*********************************************************************************************************************************************************************************************FANKE*****
***/

#include <stdio.h>
#include "lcd_spi_200.h"
#include "spi.h"
//SPI_HandleTypeDef hspi3;			// SPI_HandleTypeDef ???????

#define  LCD_SPI hspi3           // SPI????????????????

static pFONT *LCD_AsciiFonts;		// ??????»…ASCII?????
static pFONT *LCD_CHFonts;		   // ??????????????????????

// ???????SPI?????????¶»????????????????????????????ß’???
// ????????????????????????ß’????ß’???????????
// ???????????????????????????????ß’???????????????????ß’????µµ
// ???????????????????????????????ß≥??
// ???Ì‡?????????32*32??????????????ß≥? 32*32*2 = 2048 ?????????????2????
uint16_t  LCD_Buff[1024];        // LCD????????16¶À???????????2????


struct	//LCD??????????
{
	uint32_t Color;  				//	LCD??????????
	uint32_t BackColor;			//	?????
   uint8_t  ShowNum_Mode;		// ?????????
	uint8_t  Direction;			//	???????
   uint16_t Width;            // ??????????
   uint16_t Height;           // ?????????	
   uint8_t  X_Offset;         // X??????????????????????????????ß’???
   uint8_t  Y_Offset;         // Y??????????????????????????????ß’???
}LCD;



/*************************************************************************************************
*	?? ?? ??:	HAL_SPI_MspInit
*	??????:	hspi - SPI_HandleTypeDef???????????????????? SPI ???
*	?? ?? ?:	??
*	????????:	????? SPI3 ????
*	?    ??:	??		
*************************************************************************************************/

void HAL_SPI_MspInit(SPI_HandleTypeDef* hspi)
{
   GPIO_InitTypeDef GPIO_InitStruct = {0};
   if(hspi->Instance==SPI3)
   {
		__HAL_RCC_SPI3_CLK_ENABLE();	// ???SPI3???
		
      GPIO_LCD_SCK_CLK;    	 		// ??? SCK          ???????	
      GPIO_LCD_SDA_CLK;    			// ??? SDA          ???????	
		GPIO_LCD_CS_CLK;					// ??? CS           ???????	
      GPIO_LCD_Backlight_CLK;   		// ??? ????         ???????
      GPIO_LCD_DC_CLK;          		// ??? ?????????? ???????
		
// ????? SCK??MOSI
      GPIO_InitStruct.Pin 		   = LCD_SCK_PIN;      	// SCK????
      GPIO_InitStruct.Mode 		= GPIO_MODE_AF_PP;           	 	// ???????????
      GPIO_InitStruct.Pull 		= GPIO_NOPULL;                	// ????????
      GPIO_InitStruct.Speed 		= GPIO_SPEED_FREQ_VERY_HIGH;  	// ????????
		GPIO_InitStruct.Alternate 	= GPIO_AF6_SPI3;				
      HAL_GPIO_Init(LCD_SCK_PORT, &GPIO_InitStruct);

      GPIO_InitStruct.Pin 		   = LCD_SDA_PIN;      	// SCK??MOSI????		
      HAL_GPIO_Init(LCD_SDA_PORT, &GPIO_InitStruct);
		

// ?????????????????? SPI ??

		GPIO_InitStruct.Pin 		= LCD_CS_PIN;						// ???? ????
		GPIO_InitStruct.Mode 	= GPIO_MODE_OUTPUT_PP;			// ?????????
		GPIO_InitStruct.Pull 	= GPIO_NOPULL;					   // ????????
		GPIO_InitStruct.Speed 	= GPIO_SPEED_FREQ_HIGH;			// ???????
		HAL_GPIO_Init(LCD_CS_PORT, &GPIO_InitStruct);			// ?????  
  
// ????? ???? ????  
		GPIO_InitStruct.Pin 		= LCD_Backlight_PIN;				// ???? ????
		GPIO_InitStruct.Mode 	= GPIO_MODE_OUTPUT_PP;			// ?????????
		GPIO_InitStruct.Pull 	= GPIO_NOPULL;					   // ????????
		GPIO_InitStruct.Speed 	= GPIO_SPEED_FREQ_LOW;			// ???????
		HAL_GPIO_Init(LCD_Backlight_PORT, &GPIO_InitStruct);	// ?????  

// ????? ?????????? ????  
		GPIO_InitStruct.Pin 		= LCD_DC_PIN;				      // ?????????? ????
		GPIO_InitStruct.Mode 	= GPIO_MODE_OUTPUT_PP;			// ?????????
		GPIO_InitStruct.Pull 	= GPIO_NOPULL;						// ????????
		GPIO_InitStruct.Speed 	= GPIO_SPEED_FREQ_HIGH;			// ???????
		HAL_GPIO_Init(LCD_DC_PORT, &GPIO_InitStruct);	      // ?????  
		
		LCD_DC_Data;			// DC???????????????ß’??????
		LCD_CS_H;				// ??????????????
		LCD_Backlight_OFF;  	// ?????????????????????		
   }
}

	  
/*************************************************************************************************
*	?? ?? ??:	MX_SPI3_Init
*	??????:	??
*	?? ?? ?:	??
*	????????:	?????SPI????
*	?    ??:	????????	 
*************************************************************************************************/
/*
void MX_SPI3_Init(void)
{
	LCD_SPI.Instance 									= SPI3;							   					//	???SPI3
	LCD_SPI.Init.Mode 								= SPI_MODE_MASTER;            					//	??????
	LCD_SPI.Init.Direction 							= SPI_DIRECTION_1LINE;       					   //	????
	LCD_SPI.Init.DataSize 							= SPI_DATASIZE_8BIT;          					//	8¶À??????
	LCD_SPI.Init.CLKPolarity 						= SPI_POLARITY_LOW;           					//	CLK????????????
	LCD_SPI.Init.CLKPhase 							= SPI_PHASE_1EDGE;            					//	??????CLK???????????ßπ
	LCD_SPI.Init.NSS 									= SPI_NSS_SOFT;        								//	?????   
	
// SPI3 ??????APB1????????????42MHz	
// ?????2????????21MHz??SPI???????
	LCD_SPI.Init.BaudRatePrescaler 				= SPI_BAUDRATEPRESCALER_2;							// 2???
	
	LCD_SPI.Init.FirstBit	 						= SPI_FIRSTBIT_MSB;									//	??¶À????
	LCD_SPI.Init.TIMode 								= SPI_TIMODE_DISABLE;         					//	???TI??
	LCD_SPI.Init.CRCCalculation					= SPI_CRCCALCULATION_DISABLE; 					//	???CRC
	LCD_SPI.Init.CRCPolynomial 					= 0x0;                        					// CRCßµ?????????®∞???				

   HAL_SPI_Init(&LCD_SPI);       // ?????SPI

// ??????ßπ??????????SPI?????®π??????????????HAL???????????????????????????????????2??   
   __HAL_SPI_ENABLE(&LCD_SPI);   // ???SPI
   SPI_1LINE_TX(&LCD_SPI);       // ?????????
}*/


/*****************************************************************************************
*	?? ?? ??: LCD_WriteCMD
*	??????: CMD - ???ß’?????????
*	?? ?? ?: ??
*	????????: ????ß’???????
*	?    ??: ??
******************************************************************************************/

void  LCD_WriteCommand(uint8_t lcd_command)
{

	while((LCD_SPI.Instance->SR & 0x0080) != RESET); 	// ???ßÿ?SPI?????ßµ??????????
	
	LCD_DC_Command;	//	DC??????????????ß’???	

	(&LCD_SPI)->Instance->DR = lcd_command;		// ????????
	while( (LCD_SPI.Instance->SR & 0x0002) == 0);		// ???????????????
	while( (LCD_SPI.Instance->SR & 0x0080) != RESET);	//	?????????

	LCD_DC_Data;	//	DC??????????????ß’????		
}

/****************************************************************************************************************************************
*	?? ?? ??: LCD_WriteData_8bit
*
*	??????: lcd_data - ???ß’????????8¶À
*
*	????????: ß’??8¶À????
*	
****************************************************************************************************************************************/

void  LCD_WriteData_8bit(uint8_t lcd_data)
{
	LCD_SPI.Instance->DR = lcd_data;									// ????????
	while( (LCD_SPI.Instance->SR & 0x0002) == 0);		// ???????????????
}

/****************************************************************************************************************************************
*	?? ?? ??: LCD_WriteData_16bit
*
*	??????: lcd_data - ???ß’????????16¶À
*
*	????????: ß’??16¶À????
*	
****************************************************************************************************************************************/

void  LCD_WriteData_16bit(uint16_t lcd_data)
{
	LCD_SPI.Instance->DR = lcd_data>>8;								// ???????????8¶À
	while( (LCD_SPI.Instance->SR & 0x0002) == 0);		// ???????????????
	LCD_SPI.Instance->DR = lcd_data;									// ???????????8¶À
	while( (LCD_SPI.Instance->SR & 0x0002) == 0);		// ???????????????
}

/****************************************************************************************************************************************
*	?? ?? ??: LCD_WriteBuff
*
*	??????: DataBuff - ????????DataSize - ???????
*
*	????????: ????ß’??????????
*	
****************************************************************************************************************************************/

void  LCD_WriteBuff(uint16_t *DataBuff, uint16_t DataSize)
{
	uint32_t i;

   LCD_SPI.Instance->CR1 &= 0xFFBF;					// ???SPI
   LCD_SPI.Instance->CR1 |= 0x0800;	            // ?ß›???16¶À??????
   LCD_SPI.Instance->CR1 |= 0x0040;					// ???SPI
	
	LCD_CS_L;	// ??????????IC
	
	for(i=0;i<DataSize;i++)				
	{

		LCD_SPI.Instance->DR = DataBuff[i];
	   while( (LCD_SPI.Instance->SR & 0x0002) == 0);		// ???????????????

	}
	while( (LCD_SPI.Instance->SR & 0x0080) != RESET);	//	?????????
	LCD_CS_H;	// ??????	
	
	LCD_SPI.Instance->CR1 &= 0xFFBF;	// ???SPI
   LCD_SPI.Instance->CR1 &= 0xF7FF;	// ?ß›???8¶À??????
   LCD_SPI.Instance->CR1 |= 0x0040;	// ???SPI	
}

/****************************************************************************************************************************************
*	?? ?? ??: SPI_LCD_Init
*
*	????????: ?????SPI????????????????????
*	
****************************************************************************************************************************************/

void SPI_LCD_Init(void)
{
   MX_SPI3_Init();               // ?????SPI?????????

   HAL_Delay(10);               // ?????????¶À??????????¶À??????????5ms??????????

	LCD_CS_L;	// ??????????IC????????

 	LCD_WriteCommand(0x36);       // ????????? ??????????°¬?????????
	LCD_WriteData_8bit(0x00);     // ???®Æ? ???????????????RGB??????

	LCD_WriteCommand(0x3A);			// ????????? ?????????????? 12¶À??16¶À????18¶À?
	LCD_WriteData_8bit(0x05);     // ??????®Æ? 16¶À ??????

// ?????????????????????????®Æ???????
 	LCD_WriteCommand(0xB2);			
	LCD_WriteData_8bit(0x0C);
	LCD_WriteData_8bit(0x0C); 
	LCD_WriteData_8bit(0x00); 
	LCD_WriteData_8bit(0x33); 
	LCD_WriteData_8bit(0x33); 			

	LCD_WriteCommand(0xB7);		   // ?????????????	
	LCD_WriteData_8bit(0x35);     // VGH = 13.26V??VGL = -10.43V

	LCD_WriteCommand(0xBB);			// ??????????????
	LCD_WriteData_8bit(0x19);     // VCOM = 1.35V

	LCD_WriteCommand(0xC0);
	LCD_WriteData_8bit(0x2C);

	LCD_WriteCommand(0xC2);       // VDV ?? VRH ???????
	LCD_WriteData_8bit(0x01);     // VDV ?? VRH ?????????????

	LCD_WriteCommand(0xC3);			// VRH??? ???????  
	LCD_WriteData_8bit(0x12);     // VRH??? = 4.6+( vcom+vcom offset+vdv)
				
	LCD_WriteCommand(0xC4);		   // VDV??? ???????	
	LCD_WriteData_8bit(0x20);     // VDV??? = 0v

	LCD_WriteCommand(0xC6); 		// ?????????????????
	LCD_WriteData_8bit(0x0F);   	// ??????????????????????60?    

	LCD_WriteCommand(0xD0);			// ??????????
	LCD_WriteData_8bit(0xA4);     // ??ßπ????????ß’??0xA4
	LCD_WriteData_8bit(0xA1);     // AVDD = 6.8V ??AVDD = -4.8V ??VDS = 2.3V

	LCD_WriteCommand(0xE0);       // ?????????????
	LCD_WriteData_8bit(0xD0);
	LCD_WriteData_8bit(0x04);
	LCD_WriteData_8bit(0x0D);
	LCD_WriteData_8bit(0x11);
	LCD_WriteData_8bit(0x13);
	LCD_WriteData_8bit(0x2B);
	LCD_WriteData_8bit(0x3F);
	LCD_WriteData_8bit(0x54);
	LCD_WriteData_8bit(0x4C);
	LCD_WriteData_8bit(0x18);
	LCD_WriteData_8bit(0x0D);
	LCD_WriteData_8bit(0x0B);
	LCD_WriteData_8bit(0x1F);
	LCD_WriteData_8bit(0x23);

	LCD_WriteCommand(0xE1);      // ?????????????
	LCD_WriteData_8bit(0xD0);
	LCD_WriteData_8bit(0x04);
	LCD_WriteData_8bit(0x0C);
	LCD_WriteData_8bit(0x11);
	LCD_WriteData_8bit(0x13);
	LCD_WriteData_8bit(0x2C);
	LCD_WriteData_8bit(0x3F);
	LCD_WriteData_8bit(0x44);
	LCD_WriteData_8bit(0x51);
	LCD_WriteData_8bit(0x2F);
	LCD_WriteData_8bit(0x1F);
	LCD_WriteData_8bit(0x1F);
	LCD_WriteData_8bit(0x20);
	LCD_WriteData_8bit(0x23);

	LCD_WriteCommand(0x21);       // ?????????????????????????????????

 // ??????????LCD??????????????¶À?????????????????? ?????????????????????????  
	LCD_WriteCommand(0x11);       // ??????? ???
   HAL_Delay(120);               // ??????120ms???????????????????????

 // ????????LCD??????????????¶À?????????????? 
	LCD_WriteCommand(0x29);       // ?????   	

	while( (LCD_SPI.Instance->SR & 0x0080) != RESET);	//	?????????
	LCD_CS_H;	// ??????		

// ????????ßª?????????????
   LCD_SetDirection(Direction_V);  	      //	???????????
	LCD_SetBackColor(LCD_BLACK);           // ????????
   LCD_SetColor(LCD_WHITE);               // ????????  
	LCD_Clear();                           // ????

   LCD_SetAsciiFont(&ASCII_Font24);       // ???????????
   LCD_ShowNumMode(Fill_Zero);	      	// ??????????????????¶À??????????0

// ?????????????????	
   LCD_Backlight_ON;  // ???????????????????
	
}

/****************************************************************************************************************************************
*	?? ?? ??:	 LCD_SetAddress
*
*	??????:	 x1 - ?????????   y1 - ??????????  
*              x2 - ?????????   y2 - ????????	   
*	
*	????????:   ????????????????????		 			 
*****************************************************************************************************************************************/

void LCD_SetAddress(uint16_t x1,uint16_t y1,uint16_t x2,uint16_t y2)		
{
	LCD_CS_L;	// ??????????IC
	
	LCD_WriteCommand(0x2a);			//	?ß÷?????????X????
	LCD_WriteData_16bit(x1+LCD.X_Offset);
	LCD_WriteData_16bit(x2+LCD.X_Offset);

	LCD_WriteCommand(0x2b);			//	?ß÷?????????Y????
	LCD_WriteData_16bit(y1+LCD.Y_Offset);
	LCD_WriteData_16bit(y2+LCD.Y_Offset);

	LCD_WriteCommand(0x2c);			//	???ß’????????????????????
	
	while( (LCD_SPI.Instance->SR & 0x0080) != RESET);	//	?????????
	LCD_CS_H;	// ??????		
}

/****************************************************************************************************************************************
*	?? ?? ??:	LCD_SetColor
*
*	??????:	Color - ????????????????0x0000FF ??????
*
*	????????:	?????????????????????????????????????????????????
*
*	?    ??:	1. ???????????????????????????? Color ???24¶À RGB888???????????????????????????????
*					2. 24¶À??????ßµ????¶À????¶À????? R??G??B  3????????
*
*****************************************************************************************************************************************/

void LCD_SetColor(uint32_t Color)
{
	uint16_t Red_Value = 0, Green_Value = 0, Blue_Value = 0; //?????????????

	Red_Value   = (uint16_t)((Color&0x00F80000)>>8);   // ????? 16¶À ??RGB565???
	Green_Value = (uint16_t)((Color&0x0000FC00)>>5);
	Blue_Value  = (uint16_t)((Color&0x000000F8)>>3);

	LCD.Color = (uint16_t)(Red_Value | Green_Value | Blue_Value);  // ?????ß’?????LCD????		
}

/****************************************************************************************************************************************
*	?? ?? ??:	LCD_SetBackColor
*
*	??????:	Color - ????????????????0x0000FF ??????
*
*	????????:	????????,????????????????????????????
*
*	?    ??:	1. ???????????????????????????? Color ???24¶À RGB888???????????????????????????????
*					2. 24¶À??????ßµ????¶À????¶À????? R??G??B  3????????
*
*****************************************************************************************************************************************/

void LCD_SetBackColor(uint32_t Color)
{
	uint16_t Red_Value = 0, Green_Value = 0, Blue_Value = 0; //?????????????

	Red_Value   = (uint16_t)((Color&0x00F80000)>>8);   // ????? 16¶À ??RGB565???
	Green_Value = (uint16_t)((Color&0x0000FC00)>>5);
	Blue_Value  = (uint16_t)((Color&0x000000F8)>>3);

	LCD.BackColor = (uint16_t)(Red_Value | Green_Value | Blue_Value);	// ?????ß’?????LCD????			   	
}

/****************************************************************************************************************************************
*	?? ?? ??:	LCD_SetDirection
*
*	??????:	direction - ?????????
*
*	????????:	?????????????
*
*	?    ??:   1. ????????? Direction_H ??Direction_V ??Direction_H_Flip ??Direction_V_Flip        
*              2. ?????? LCD_DisplayDirection(Direction_H) ??????????????????
*
*****************************************************************************************************************************************/

void LCD_SetDirection(uint8_t direction)
{
	LCD.Direction = direction;    // ß’?????LCD????

	LCD_CS_L;	// ??????????IC
			
   if( direction == Direction_H )   // ???????
   {
      LCD_WriteCommand(0x36);    		// ????????? ??????????°¬?????????
      LCD_WriteData_8bit(0x70);        // ???????
      LCD.X_Offset   = 0;             // ??????????????????
      LCD.Y_Offset   = 0;   
      LCD.Width      = LCD_Height;		// ????????????
      LCD.Height     = LCD_Width;		
   }
   else if( direction == Direction_V )
   {
      LCD_WriteCommand(0x36);    		// ????????? ??????????°¬?????????
      LCD_WriteData_8bit(0x00);        // ??????
      LCD.X_Offset   = 0;              // ??????????????????
      LCD.Y_Offset   = 0;     
      LCD.Width      = LCD_Width;		// ????????????
      LCD.Height     = LCD_Height;						
   }
   else if( direction == Direction_H_Flip )
   {
      LCD_WriteCommand(0x36);   			 // ????????? ??????????°¬?????????
      LCD_WriteData_8bit(0xA0);         // ???????????????????RGB??????
      LCD.X_Offset   = 0;              // ??????????????????
      LCD.Y_Offset   = 0;      
      LCD.Width      = LCD_Height;		 // ????????????
      LCD.Height     = LCD_Width;				
   }
   else if( direction == Direction_V_Flip )
   {
      LCD_WriteCommand(0x36);    		// ????????? ??????????°¬?????????
      LCD_WriteData_8bit(0xC0);        // ?????? ????????????RGB??????
      LCD.X_Offset   = 0;              // ??????????????????
      LCD.Y_Offset   = 0;     
      LCD.Width      = LCD_Width;		// ????????????
      LCD.Height     = LCD_Height;				
   }   
	while( (LCD_SPI.Instance->SR & 0x0080) != RESET);	//	?????????
	LCD_CS_H;	// ??????			
}


/****************************************************************************************************************************************
*	?? ?? ??:	LCD_SetAsciiFont
*
*	??????:	*fonts - ??????ASCII????
*
*	????????:	????ASCII???»…???????? 3216/2412/2010/1608/1206 ?????ß≥??????
*
*	?    ??:	1. ?????? LCD_SetAsciiFont(&ASCII_Font24) ???????? 2412?? ASCII????
*					2. ??????????? lcd_fonts.c 			
*
*****************************************************************************************************************************************/

void LCD_SetAsciiFont(pFONT *Asciifonts)
{
  LCD_AsciiFonts = Asciifonts;
}


/****************************************************************************************************************************************
*	?? ?? ??:	LCD_Clear
*
*	????????:	????????????LCD???? LCD.BackColor ?????
*
*	?    ??:	???? LCD_SetBackColor() ?????????????????????®≤???????????
*
*****************************************************************************************************************************************/

void LCD_Clear(void)
{
	uint32_t i;

	LCD_SetAddress(0,0,LCD.Width-1,LCD.Height-1);			//????????	

   LCD_SPI.Instance->CR1 &= 0xFFBF;					// ???SPI
   LCD_SPI.Instance->CR1 |= 0x0800;	            // ?ß›???16¶À??????
   LCD_SPI.Instance->CR1 |= 0x0040;					// ???SPI
	
	LCD_CS_L;	// ??????????IC
	
	for(i=0;i<LCD.Width*LCD.Height;i++)				
	{

		LCD_SPI.Instance->DR = LCD.BackColor;
	   while( (LCD_SPI.Instance->SR & 0x0002) == 0);		// ???????????????
	}
	while( (LCD_SPI.Instance->SR & 0x0080) != RESET);	//	?????????
	LCD_CS_H;	// ??????	
	
	LCD_SPI.Instance->CR1 &= 0xFFBF;	// ???SPI
   LCD_SPI.Instance->CR1 &= 0xF7FF;	// ?ß›???8¶À??????
   LCD_SPI.Instance->CR1 |= 0x0040;	// ???SPI
}


/****************************************************************************************************************************************
*	?? ?? ??:	LCD_ClearRect
*
*	??????:	x - ?????????
*					y - ??????????
*					width  - ?????????????
*					height - ???????????????
*
*	????????:	??????????????????¶À?????????????? LCD.BackColor ?????
*
*	?    ??:	1. ???? LCD_SetBackColor() ?????????????????????®≤???????????
*				   2. ?????? LCD_ClearRect( 10, 10, 100, 50) ?????????(10,10)??????100??50??????
*
*****************************************************************************************************************************************/

void LCD_ClearRect(uint16_t x, uint16_t y, uint16_t width, uint16_t height)
{
	uint16_t i;

   LCD_SetAddress( x, y, x+width-1, y+height-1);	// ????????	

   LCD_SPI.Instance->CR1 &= 0xFFBF;					// ???SPI
   LCD_SPI.Instance->CR1 |= 0x0800;	            // ?ß›???16¶À??????
   LCD_SPI.Instance->CR1 |= 0x0040;					// ???SPI
	
	LCD_CS_L;	// ??????????IC
	
	for(i=0;i<width*height;i++)				
	{

		LCD_SPI.Instance->DR = LCD.BackColor;
	   while( (LCD_SPI.Instance->SR & 0x0002) == 0);		// ???????????????
	}
	while( (LCD_SPI.Instance->SR & 0x0080) != RESET);	//	?????????
	LCD_CS_H;	// ??????	
	
	LCD_SPI.Instance->CR1 &= 0xFFBF;	// ???SPI
   LCD_SPI.Instance->CR1 &= 0xF7FF;	// ?ß›???8¶À??????
   LCD_SPI.Instance->CR1 |= 0x0040;	// ???SPI
}


/****************************************************************************************************************************************
*	?? ?? ??:	LCD_DrawPoint
*
*	??????:	x - ?????????
*					y - ??????????
*					color  - ?????????????? 24¶À RGB888 ???????????????????????????????
*
*	????????:	?????????????????????
*
*	?    ??:	?????? LCD_DrawPoint( 10, 10, 0x0000FF) ????????(10,10)??????????
*
*****************************************************************************************************************************************/

void LCD_DrawPoint(uint16_t x,uint16_t y,uint32_t color)
{
	LCD_SetAddress(x,y,x,y);	//	???????? 
	
	LCD_CS_L;	// ??????????IC

	LCD_WriteData_16bit(LCD.Color)	;
	
	while( (LCD_SPI.Instance->SR & 0x0080) != RESET);	//	?????????
	LCD_CS_H;	// ??????		
} 


/****************************************************************************************************************************************
*	?? ?? ??:	LCD_DisplayChar
*
*	??????:	x - ?????????
*					y - ??????????
*					c  - ASCII???
*
*	????????:	????????????????????
*
*	?    ??:	1. ???????????????»…??????? LCD_SetAsciiFont(&ASCII_Font24) ????? 2412??ASCII????
*					2.	???????????????????????? LCD_SetColor(0xff0000FF) ????????
*					3. ??????????????????????? LCD_SetBackColor(0x000000) ??????????????
*					4. ?????? LCD_DisplayChar( 10, 10, 'a') ????????(10,10)?????? 'a'
*
*****************************************************************************************************************************************/

void LCD_DisplayChar(uint16_t x, uint16_t y,uint8_t c)
{
	uint16_t  index = 0, counter = 0 ,i = 0, w = 0;		// ????????
   uint8_t   disChar;		//?????????

	c = c - 32; 	// ????ASCII????????
	
	LCD_CS_L;	// ??????????IC


	for(index = 0; index < LCD_AsciiFonts->Sizes; index++)	
	{
		disChar = LCD_AsciiFonts->pTable[c*LCD_AsciiFonts->Sizes + index]; //??????????
		for(counter = 0; counter < 8; counter++)
		{ 
			if(disChar & 0x01)	
			{		
            LCD_Buff[i] =  LCD.Color;			// ????????0?????????????
			}
			else		
			{		
            LCD_Buff[i] = LCD.BackColor;		//????????????????
			}
			disChar >>= 1;
			i++;
         w++;
 			if( w == LCD_AsciiFonts->Width ) // ???ß’????????????????????????????
			{								   // ????????????ß’??????
				w = 0;
				break;
			}        
		}	
	}		
   LCD_SetAddress( x, y, x+LCD_AsciiFonts->Width-1, y+LCD_AsciiFonts->Height-1);	   // ????????	
   LCD_WriteBuff(LCD_Buff,LCD_AsciiFonts->Width*LCD_AsciiFonts->Height);          // ß’?????
}

/**************************************************************************************************************************************
*	?? ?? ??:	LCD_DisplayString
*
*	??????:	x - ?????????
*					y - ??????????
*					p - ASCII???????????
*
*	????????:	??????????????????????
*
*	?    ??:	1. ???????????????»…??????? LCD_SetAsciiFont(&ASCII_Font24) ????? 2412??ASCII????
*					2.	???????????????????????? LCD_SetColor(0x0000FF) ????????
*					3. ??????????????????????? LCD_SetBackColor(0x000000) ??????????????
*					4. ?????? LCD_DisplayString( 10, 10, "FANKE") ????????????(10,10)????????????"FANKE"
*
*****************************************************************************************************************************************/

void LCD_DisplayString( uint16_t x, uint16_t y, char *p) 
{  
	while ((x < LCD.Width) && (*p != 0))	//?ßÿ?????????????????????????????????
	{
		 LCD_DisplayChar( x,y,*p);
		 x += LCD_AsciiFonts->Width; //???????????
		 p++;	//????????????
	}
}

/****************************************************************************************************************************************
*	?? ?? ??:	LCD_SetTextFont
*
*	??????:	*fonts - ?????????????
*
*	????????:	??????????»…?????????ASCII?????
*
*	?    ??:	1. ???????? 3232/2424/2020/1616/1212 ?????ß≥?????????»…
*						????????????ASCII????? 3216/2412/2010/1608/1206
*					2. ??????????? lcd_fonts.c 
*					3. ?????????????ß≥??????????????????????
*					4. ?????? LCD_SetTextFont(&CH_Font24) ???????? 2424?????????????2412??ASCII???????
*
*****************************************************************************************************************************************/

void LCD_SetTextFont(pFONT *fonts)
{
	LCD_CHFonts = fonts;		// ????????????
	switch(fonts->Width )
	{
		case 12:	LCD_AsciiFonts = &ASCII_Font12;	break;	// ????ASCII?????????? 1206
		case 16:	LCD_AsciiFonts = &ASCII_Font16;	break;	// ????ASCII?????????? 1608
		case 20:	LCD_AsciiFonts = &ASCII_Font20;	break;	// ????ASCII?????????? 2010	
		case 24:	LCD_AsciiFonts = &ASCII_Font24;	break;	// ????ASCII?????????? 2412
		case 32:	LCD_AsciiFonts = &ASCII_Font32;	break;	// ????ASCII?????????? 3216		
		default: break;
	}
}
/******************************************************************************************************************************************
*	?? ?? ??:	LCD_DisplayChinese
*
*	??????:	x - ?????????
*					y - ??????????
*					pText - ???????
*
*	????????:	???????????????????????????
*
*	?    ??:	1. ???????????????»…??????? LCD_SetTextFont(&CH_Font24) ????? 2424?????????????2412??ASCII???????
*					2.	???????????????????????? LCD_SetColor(0xff0000FF) ????????
*					3. ??????????????????????? LCD_SetBackColor(0xff000000) ??????????????
*					4. ?????? LCD_DisplayChinese( 10, 10, "??") ????????(10,10)??????????"??"
*
*****************************************************************************************************************************************/

void LCD_DisplayChinese(uint16_t x, uint16_t y, char *pText) 
{
	uint16_t  i=0,index = 0, counter = 0;	// ????????
	uint16_t  addr;	// ??????
   uint8_t   disChar;	//??????
	uint16_t  Xaddress = 0; //??????

	while(1)
	{		
		// ????????ß÷????????????¶À?®≤??????????		
		if ( *(LCD_CHFonts->pTable + (i+1)*LCD_CHFonts->Sizes + 0)==*pText && *(LCD_CHFonts->pTable + (i+1)*LCD_CHFonts->Sizes + 1)==*(pText+1) )	
		{   
			addr=i;	// ?????????
			break;
		}				
		i+=2;	// ????????????????????

		if(i >= LCD_CHFonts->Table_Rows)	break;	// ????ß“?????????????	
	}	
	i=0;
	for(index = 0; index <LCD_CHFonts->Sizes; index++)
	{	
		disChar = *(LCD_CHFonts->pTable + (addr)*LCD_CHFonts->Sizes + index);	// ??????????????
		
		for(counter = 0; counter < 8; counter++)
		{ 
			if(disChar & 0x01)	
			{		
            LCD_Buff[i] =  LCD.Color;			// ????????0?????????????
			}
			else		
			{		
            LCD_Buff[i] = LCD.BackColor;		// ????????????????
			}
         i++;
			disChar >>= 1;
			Xaddress++;  //?????????
			
			if( Xaddress == LCD_CHFonts->Width ) 	//	??????????????????????????????
			{														//	????????ß÷????
				Xaddress = 0;
				break;
			}
		}	
	}	
   LCD_SetAddress( x, y, x+LCD_CHFonts->Width-1, y+LCD_CHFonts->Height-1);	   // ????????	
   LCD_WriteBuff(LCD_Buff,LCD_CHFonts->Width*LCD_CHFonts->Height);            // ß’?????
}

/*****************************************************************************************************************************************
*	?? ?? ??:	LCD_DisplayText
*
*	??????:	x - ?????????
*					y - ??????????
*					pText - ?????????????????????ASCII???
*
*	????????:	??????????????????????
*
*	?    ??:	1. ???????????????»…??????? LCD_SetTextFont(&CH_Font24) ????? 2424?????????????2412??ASCII???????
*					2.	???????????????????????? LCD_SetColor(0xff0000FF) ????????
*					3. ??????????????????????? LCD_SetBackColor(0xff000000) ??????????????
*					4. ?????? LCD_DisplayChinese( 10, 10, "??????STM32") ????????(10,10)????????"??????STM32"
*
**********************************************************************************************************************************fanke*******/

void LCD_DisplayText(uint16_t x, uint16_t y, char *pText) 
{  
 	
	while(*pText != 0)	// ?ßÿ??????????
	{
		if(*pText<=0x7F)	// ?ßÿ?????ASCII??
		{
			LCD_DisplayChar(x,y,*pText);	// ???ASCII
			x+=LCD_AsciiFonts->Width;				// ???????????????????
			pText++;								// ????????+1
		}
		else					// ??????????
		{			
			LCD_DisplayChinese(x,y,pText);	// ???????
			x+=LCD_CHFonts->Width;				// ???????????????????
			pText+=2;								// ????????+2???????????2???
		}
	}	
}



/*****************************************************************************************************************************************
*	?? ?? ??:	LCD_ShowNumMode
*
*	??????:	mode - ??????????????
*
*	????????:	???????????????¶À??0???????????????? Fill_Space ?????Fill_Zero ?????
*
*	?    ??:   1. ??? LCD_DisplayNumber() ??????? ?? LCD_DisplayDecimals()???ß≥?? ?????????????
*					2. ?????? LCD_ShowNumMode(Fill_Zero) ???????¶À???0?????? 123 ???????? 000123
*
*****************************************************************************************************************************************/

void LCD_ShowNumMode(uint8_t mode)
{
	LCD.ShowNum_Mode = mode;
}


/*****************************************************************************************************************************************
*	?? ?? ??:	LCD_DisplayNumber
*
*	??????:	x - ?????????
*					y - ??????????
*					number - ??????????,??¶∂?? -2147483648~2147483647 ???
*					len - ?????¶À???????¶À??????len??????????????????????????????????????????¶À???????????
*
*	????????:	?????????????????????????
*
*	?    ??:	1. ???????????????»…??????? LCD_SetAsciiFont(&ASCII_Font24) ???????ASCII???????
*					2.	???????????????????????? LCD_SetColor(0x0000FF) ????????
*					3. ??????????????????????? LCD_SetBackColor(0x000000) ??????????????
*					4. ?????? LCD_DisplayNumber( 10, 10, a, 5) ????????(10,10)??????????a,???5¶À??????¶À??0????
*						???? a=123 ???????? LCD_ShowNumMode()???????????  123(??????????¶À) ????00123
*						
*****************************************************************************************************************************************/

void  LCD_DisplayNumber( uint16_t x, uint16_t y, int32_t number, uint8_t len) 
{  
	char   Number_Buffer[15];				// ????????????????

	if( LCD.ShowNum_Mode == Fill_Zero)	// ????¶À??0
	{
		sprintf( Number_Buffer , "%0.*d",len, number );	// ?? number ???????????????????		
	}
	else			// ????¶À?????
	{	
		sprintf( Number_Buffer , "%*d",len, number );	// ?? number ???????????????????		
	}
	
	LCD_DisplayString( x, y,(char *)Number_Buffer) ;  // ??????????????????????
	
}

/***************************************************************************************************************************************
*	?? ?? ??:	LCD_DisplayDecimals
*
*	??????:	x - ?????????
*					y - ??????????
*					decimals - ??????????, double????1.7 x 10^??-308??~ 1.7 x 10^??+308???????????????????ßπ¶À???15~16¶À
*
*       			len - ????????????¶À????????ß≥???????????????????¶À???????????????¶À?????????????????¶À?????
*							???1??ß≥?? -123.123 ????? len <=8 ???????????????? -123.123
*							???2??ß≥?? -123.123 ????? len =10 ?????????????   -123.123(?????????????????¶À) 
*							???3??ß≥?? -123.123 ????? len =10 ??????????®≤??? LCD_ShowNumMode() ????????0??????????? -00123.123 
*
*					decs - ???????ß≥??¶À??????ß≥???????¶À?????????????ß≥??¶À??????????????????????
*							 ?????1.12345 ????? decs ?4¶À??????????????1.1235
*
*	????????:	??????????????????????????ß≥??
*
*	?    ??:	1. ???????????????»…??????? LCD_SetAsciiFont(&ASCII_Font24) ???????ASCII???????
*					2.	???????????????????????? LCD_SetColor(0x0000FF) ????????
*					3. ??????????????????????? LCD_SetBackColor(0x000000) ??????????????
*					4. ?????? LCD_DisplayDecimals( 10, 10, a, 5, 3) ????????(10,10)????????a,??????5¶À?????ß“???3¶Àß≥??
*						
*****************************************************************************************************************************************/

void  LCD_DisplayDecimals( uint16_t x, uint16_t y, double decimals, uint8_t len, uint8_t decs) 
{  
	char  Number_Buffer[20];				// ????????????????
	
	if( LCD.ShowNum_Mode == Fill_Zero)	// ????¶À???0??
	{
		sprintf( Number_Buffer , "%0*.*lf",len,decs, decimals );	// ?? number ???????????????????		
	}
	else		// ????¶À?????
	{
		sprintf( Number_Buffer , "%*.*lf",len,decs, decimals );	// ?? number ???????????????????		
	}
	
	LCD_DisplayString( x, y,(char *)Number_Buffer) ;	// ??????????????????????
}


/***************************************************************************************************************************************
*	?? ?? ??: LCD_DrawLine
*
*	??????: x1 - ??? ??????
*			 	 y1 - ??? ???????
*
*				 x2 - ??? ??????
*            y2 - ??? ???????
*
*	????????: ???????????
*
*	?    ??: ?®≤????????ST??????????????
*						 
*****************************************************************************************************************************************/

#define ABS(X)  ((X) > 0 ? (X) : -(X))    

void LCD_DrawLine(uint16_t x1, uint16_t y1, uint16_t x2, uint16_t y2)
{
	int16_t deltax = 0, deltay = 0, x = 0, y = 0, xinc1 = 0, xinc2 = 0, 
	yinc1 = 0, yinc2 = 0, den = 0, num = 0, numadd = 0, numpixels = 0, 
	curpixel = 0;

	deltax = ABS(x2 - x1);        /* The difference between the x's */
	deltay = ABS(y2 - y1);        /* The difference between the y's */
	x = x1;                       /* Start x off at the first pixel */
	y = y1;                       /* Start y off at the first pixel */

	if (x2 >= x1)                 /* The x-values are increasing */
	{
	 xinc1 = 1;
	 xinc2 = 1;
	}
	else                          /* The x-values are decreasing */
	{
	 xinc1 = -1;
	 xinc2 = -1;
	}

	if (y2 >= y1)                 /* The y-values are increasing */
	{
	 yinc1 = 1;
	 yinc2 = 1;
	}
	else                          /* The y-values are decreasing */
	{
	 yinc1 = -1;
	 yinc2 = -1;
	}

	if (deltax >= deltay)         /* There is at least one x-value for every y-value */
	{
	 xinc1 = 0;                  /* Don't change the x when numerator >= denominator */
	 yinc2 = 0;                  /* Don't change the y for every iteration */
	 den = deltax;
	 num = deltax / 2;
	 numadd = deltay;
	 numpixels = deltax;         /* There are more x-values than y-values */
	}
	else                          /* There is at least one y-value for every x-value */
	{
	 xinc2 = 0;                  /* Don't change the x for every iteration */
	 yinc1 = 0;                  /* Don't change the y when numerator >= denominator */
	 den = deltay;
	 num = deltay / 2;
	 numadd = deltax;
	 numpixels = deltay;         /* There are more y-values than x-values */
	}
	for (curpixel = 0; curpixel <= numpixels; curpixel++)
	{
	 LCD_DrawPoint(x,y,LCD.Color);             /* Draw the current pixel */
	 num += numadd;              /* Increase the numerator by the top of the fraction */
	 if (num >= den)             /* Check if numerator >= denominator */
	 {
		num -= den;               /* Calculate the new numerator value */
		x += xinc1;               /* Change the x as appropriate */
		y += yinc1;               /* Change the y as appropriate */
	 }
	 x += xinc2;                 /* Change the x as appropriate */
	 y += yinc2;                 /* Change the y as appropriate */
	}  
}


/***************************************************************************************************************************************
*	?? ?? ??: LCD_DrawLine_V
*
*	??????: x - ??????
*			 	 y - ???????
*				 height - ??????
*
*	????????: ?????¶À????????????? ??? ??
*
*	?    ??: 1. ?®≤????????ST??????????????
*				 2. ???????????????????????????		
*            3. ???????????????????????????????? LCD_DrawLine ????
*  ????????
*****************************************************************************************************************************************/

void LCD_DrawLine_V(uint16_t x, uint16_t y, uint16_t height)
{
   uint16_t i ; // ????????

	for (i = 0; i < height; i++)
	{
       LCD_Buff[i] =  LCD.Color;  // ß’??????
   }   
   LCD_SetAddress( x, y, x, y+height-1);	     // ????????	

   LCD_WriteBuff(LCD_Buff,height);          // ß’?????
}

/***************************************************************************************************************************************
*	?? ?? ??: LCD_DrawLine_H
*
*	??????: x - ??????
*			 	 y - ???????
*				 width  - ?????
*
*	????????: ?????¶À????????????? ?? ??
*
*	?    ??: 1. ?®≤????????ST??????????????
*				 2. ???????????????????????????		
*            3. ??????? ?? ?????????????????????? LCD_DrawLine ????
*  ????????
**********************************************************************************************************************************fanke*******/

void LCD_DrawLine_H(uint16_t x, uint16_t y, uint16_t width)
{
   uint16_t i ; // ????????

	for (i = 0; i < width; i++)
	{
       LCD_Buff[i] =  LCD.Color;  // ß’??????
   }   
   LCD_SetAddress( x, y, x+width-1, y);	     // ????????	

   LCD_WriteBuff(LCD_Buff,width);          // ß’?????
}

/***************************************************************************************************************************************
*	?? ?? ??: LCD_DrawRect
*
*	??????: x - ??????
*			 	 y - ???????
*			 	 width  - ?????
*				 height - ??????
*
*	????????: ?????¶À????????????????????
*
*	?    ??: 1. ?®≤????????ST??????????????
*				 2. ???????????????????????????
*						 
*****************************************************************************************************************************************/

void LCD_DrawRect(uint16_t x, uint16_t y, uint16_t width, uint16_t height)
{
   // ????????
   LCD_DrawLine_H( x,  y,  width);           
   LCD_DrawLine_H( x,  y+height-1,  width);

   // ????????
   LCD_DrawLine_V( x,  y,  height);
   LCD_DrawLine_V( x+width-1,  y,  height);
}



/***************************************************************************************************************************************
*	?? ?? ??: LCD_DrawCircle
*
*	??????: x - ??? ??????
*			 	 y - ??? ???????
*			 	 r  - ??
*
*	????????: ?????? (x,y) ?????? r ?????????
*
*	?    ??: 1. ?®≤????????ST??????????????
*				 2. ???????????????????????????
*
*****************************************************************************************************************************************/

void LCD_DrawCircle(uint16_t x, uint16_t y, uint16_t r)
{
	int Xadd = -r, Yadd = 0, err = 2-2*r, e2;
	do {   

		LCD_DrawPoint(x-Xadd,y+Yadd,LCD.Color);
		LCD_DrawPoint(x+Xadd,y+Yadd,LCD.Color);
		LCD_DrawPoint(x+Xadd,y-Yadd,LCD.Color);
		LCD_DrawPoint(x-Xadd,y-Yadd,LCD.Color);
		
		e2 = err;
		if (e2 <= Yadd) {
			err += ++Yadd*2+1;
			if (-Xadd == Yadd && e2 <= Xadd) e2 = 0;
		}
		if (e2 > Xadd) err += ++Xadd*2+1;
    }
    while (Xadd <= 0);   
}


/***************************************************************************************************************************************
*	?? ?? ??: LCD_DrawEllipse
*
*	??????: x - ??? ??????
*			 	 y - ??? ???????
*			 	 r1  - ??????????
*				 r2  - ???????????
*
*	????????: ?????? (x,y) ??????????? r1 ???????? r2 ?????????
*
*	?    ??: 1. ?®≤????????ST??????????????
*				 2. ???????????????????????????
*
*****************************************************************************************************************************************/

void LCD_DrawEllipse(int x, int y, int r1, int r2)
{
  int Xadd = -r1, Yadd = 0, err = 2-2*r1, e2;
  float K = 0, rad1 = 0, rad2 = 0;
   
  rad1 = r1;
  rad2 = r2;
  
  if (r1 > r2)
  { 
    do {
      K = (float)(rad1/rad2);
		 
		LCD_DrawPoint(x-Xadd,y+(uint16_t)(Yadd/K),LCD.Color);
		LCD_DrawPoint(x+Xadd,y+(uint16_t)(Yadd/K),LCD.Color);
		LCD_DrawPoint(x+Xadd,y-(uint16_t)(Yadd/K),LCD.Color);
		LCD_DrawPoint(x-Xadd,y-(uint16_t)(Yadd/K),LCD.Color);     
		 
      e2 = err;
      if (e2 <= Yadd) {
        err += ++Yadd*2+1;
        if (-Xadd == Yadd && e2 <= Xadd) e2 = 0;
      }
      if (e2 > Xadd) err += ++Xadd*2+1;
    }
    while (Xadd <= 0);
  }
  else
  {
    Yadd = -r2; 
    Xadd = 0;
    do { 
      K = (float)(rad2/rad1);

		LCD_DrawPoint(x-(uint16_t)(Xadd/K),y+Yadd,LCD.Color);
		LCD_DrawPoint(x+(uint16_t)(Xadd/K),y+Yadd,LCD.Color);
		LCD_DrawPoint(x+(uint16_t)(Xadd/K),y-Yadd,LCD.Color);
		LCD_DrawPoint(x-(uint16_t)(Xadd/K),y-Yadd,LCD.Color);  
		 
      e2 = err;
      if (e2 <= Xadd) {
        err += ++Xadd*3+1;
        if (-Yadd == Xadd && e2 <= Yadd) e2 = 0;
      }
      if (e2 > Yadd) err += ++Yadd*3+1;     
    }
    while (Yadd <= 0);
  }
}


/***************************************************************************************************************************************
*	?? ?? ??: LCD_FillCircle
*
*	??????: x - ??? ??????
*			 	 y - ??? ???????
*			 	 r  - ??
*
*	????????: ?????? (x,y) ????? r ?????????
*
*	?    ??: 1. ?®≤????????ST??????????????
*				 2. ???????????????????????????
*
*****************************************************************************************************************************************/

void LCD_FillCircle(uint16_t x, uint16_t y, uint16_t r)
{
  int32_t  D;    /* Decision Variable */ 
  uint32_t  CurX;/* Current X Value */
  uint32_t  CurY;/* Current Y Value */ 
  
  D = 3 - (r << 1);
  
  CurX = 0;
  CurY = r;
  
  while (CurX <= CurY)
  {
    if(CurY > 0) 
    { 
      LCD_DrawLine_V(x - CurX, y - CurY,2*CurY);
      LCD_DrawLine_V(x + CurX, y - CurY,2*CurY);
    }
    
    if(CurX > 0) 
    {
		// LCD_DrawLine(x - CurY, y - CurX,x - CurY,y - CurX + 2*CurX);
		// LCD_DrawLine(x + CurY, y - CurX,x + CurY,y - CurX + 2*CurX); 	

      LCD_DrawLine_V(x - CurY, y - CurX,2*CurX);
      LCD_DrawLine_V(x + CurY, y - CurX,2*CurX);
    }
    if (D < 0)
    { 
      D += (CurX << 2) + 6;
    }
    else
    {
      D += ((CurX - CurY) << 2) + 10;
      CurY--;
    }
    CurX++;
  }
  LCD_DrawCircle(x, y, r);  
}

/***************************************************************************************************************************************
*	?? ?? ??: LCD_FillRect
*
*	??????: x - ??????
*			 	 y - ???????
*			 	 width  - ?????
*				 height -??????
*
*	????????: ?????? (x,y) ?????????????????
*
*	?    ??: ???????????????????????????
*						 
*****************************************************************************************************************************************/

void LCD_FillRect(uint16_t x, uint16_t y, uint16_t width, uint16_t height)
{
	uint16_t i;

   LCD_SetAddress( x, y, x+width-1, y+height-1);	// ????????	

   LCD_SPI.Instance->CR1 &= 0xFFBF;					// ???SPI
   LCD_SPI.Instance->CR1 |= 0x0800;	            // ?ß›???16¶À??????
   LCD_SPI.Instance->CR1 |= 0x0040;					// ???SPI
	
	LCD_CS_L;	// ??????????IC
	
	for(i=0;i<width*height;i++)				
	{

		LCD_SPI.Instance->DR = LCD.Color;
	   while( (LCD_SPI.Instance->SR & 0x0002) == 0);		// ???????????????
	}
	while( (LCD_SPI.Instance->SR & 0x0080) != RESET);	//	?????????
	LCD_CS_H;	// ??????	
	
	LCD_SPI.Instance->CR1 &= 0xFFBF;	// ???SPI
   LCD_SPI.Instance->CR1 &= 0xF7FF;	// ?ß›???8¶À??????
   LCD_SPI.Instance->CR1 |= 0x0040;	// ???SPI
}


/***************************************************************************************************************************************
*	?? ?? ??: LCD_DrawImage
*
*	??????: x - ?????????
*				 y - ??????????
*			 	 width  - ?????????
*				 height - ?????????
*				*pImage - ???????????????
*
*	????????: ??????????????
*
*	?    ??: 1.???????????????????????????????????
*            2.??? LCD_SetColor() ??????????????LCD_SetBackColor() ????????
*						 
*****************************************************************************************************************************************/

void 	LCD_DrawImage(uint16_t x,uint16_t y,uint16_t width,uint16_t height,const uint8_t *pImage) 
{  
   uint8_t   disChar;	         // ??????
	uint16_t  Xaddress = x;       // ??????
 	uint16_t  Yaddress = y;       // ???????  
	uint16_t  i=0,j=0,m=0;        // ????????
	uint16_t  BuffCount = 0;      // ??????????
   uint16_t  Buff_Height = 0;    // ????????????

// ???????????ß≥????????????ß’??
   Buff_Height = (sizeof(LCD_Buff)/2) / height;    // ???????????ß’???????????

	for(i = 0; i <height; i++)             // ???????ß’??
	{
		for(j = 0; j <(float)width/8; j++)  
		{
			disChar = *pImage;

			for(m = 0; m < 8; m++)
			{ 
				if(disChar & 0x01)	
				{		
               LCD_Buff[BuffCount] =  LCD.Color;			// ????????0?????????????
				}
				else		
				{		
				   LCD_Buff[BuffCount] = LCD.BackColor;		//????????????????
				}
				disChar >>= 1;     // ????¶À
				Xaddress++;        // ?????????
				BuffCount++;       // ??????????       
				if( (Xaddress - x)==width ) // ??????????????????????????????,????????ß÷????		
				{											 
					Xaddress = x;				                 
					break;
				}
			}	
			pImage++;			
		}
      if( BuffCount == Buff_Height*width  )  // ?????????????????????????
      {
         BuffCount = 0; // ????????????0

         LCD_SetAddress( x, Yaddress , x+width-1, Yaddress+Buff_Height-1);	// ????????	
         LCD_WriteBuff(LCD_Buff,width*Buff_Height);          // ß’?????     

         Yaddress = Yaddress+Buff_Height;    // ?????????????ß’?????????????
      }     
      if( (i+1)== height ) // ???????????
      {
         LCD_SetAddress( x, Yaddress , x+width-1,i+y);	   // ????????	
         LCD_WriteBuff(LCD_Buff,width*(i+1+y-Yaddress));    // ß’?????     
      }
	}	
}




/**************************************************************************************************************************************************************************************************************************************???? STM32F4?????******************************FANKE***/
// ??????????? STM32F4?????
//


